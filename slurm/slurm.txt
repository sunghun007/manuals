1.ë¨¼ì§€ì„¤ì¹˜

/etc/hosts ****** ê°ì„œë²„ì— ipì£¼ì†Œ í˜¸ìŠ¤íŠ¸ë„¤ì„ ë“±ë¡ í•˜ê¸° ( 192.0.0.0 hostname)

$ export MUNGEUSER=991
$ sudo groupadd -g $MUNGEUSER munge
$ sudo useradd  -m -c "MUNGE Uid 'N' Gid Emporium" -d /var/lib/munge -u $MUNGEUSER -g munge  -s /sbin/nologin munge

sudo apt install munge -y


***ë§ˆìŠ¤í„°ë…¸ë“œ
$ sudo dd if=/dev/urandom of=/etc/munge/munge.key bs=1c count=4M
$ sudo ls -l /etc/munge/munge.key
$ sudo chmod a-r /etc/munge/munge.key
$ sudo chmod u-w /etc/munge/munge.key 
$ sudo chmod u+r /etc/munge/munge.key
$ sudo chown munge:munge /etc/munge/munge.key
$ sudo munge -n
$ sudo munge -n | unmunge
$ sudo scp /etc/munge/munge.key root@192.168.1.234:/etc/munge
$ sudo systemctl enable munge
$ sudo /etc/init.d/munge restart
sudo chown munge:munge /etc/munge/munge.key
sudo chmod 400 /etc/munge/munge.key

***í´ë¼ì´ì–¸íŠ¸
$ sudo ls -l /etc/munge/munge.key
$ sudo chmod a-r /etc/munge/munge.key
$ sudo chmod u-w /etc/munge/munge.key 
$ sudo chmod u+r /etc/munge/munge.key
$ sudo chown munge:munge /etc/munge/munge.key
$ sudo systemctl enable munge
$ sudo /etc/init.d/munge restart

munge -n | ssh node1 unmunge  (success ë– ì•¼í•¨)

2.ìŠ¬ëŸ¼ì„¤ì¹˜

###ì˜ì¡´ì„± íŒ¨í‚¤ì§€ ì„¤ì¹˜

sudo apt install make gcc -y
sudo apt install bzip2 -y

sudo apt-get install -y build-essential libssl-dev libmysqlclient-dev libpam0g-dev libnuma-dev libhwloc-dev libreadline-dev libncurses-dev libmunge-dev libmunge2 libcurl4-openssl-dev libjson-c-dev man2html


sudo wget https://download.schedmd.com/slurm/slurm-24.11.1.tar.bz2
sudo tar -xf slurm-23.02.4.tar.bz2
cd slurm-23.02.4
sudo ./configure --prefix=/etc/slurm (prefixì— ì›í•˜ëŠ” ê²½ë¡œ ì§€ì •)
sudo make
sudo make install

####slurm ìœ ì € ìƒì„±

sudo groupadd slurm
sudo useradd -r -m -g slurm slurm

#### slurmctld.service , slurmd.service ìƒì„±

/etc/systemd/system/slurmctld.service
ì˜ˆ)
[Unit]
Description=Slurmctld Daemon
After=network.target

[Service]
Type=forking
ExecStart=/usr/local/sbin/slurmctld
ExecReload=/bin/kill -HUP $MAINPID
PIDFile=/var/run/slurmctld.pid
User=root
Group=root

[Install]
WantedBy=multi-user.target

/etc/systemd/system/slurmd.service
ì˜ˆ)
[Unit]
Description=Slurm Daemon
After=network.target

[Service]
Type=forking
ExecStart=/usr/local/sbin/slurmd
ExecReload=/bin/kill -HUP $MAINPID
PIDFile=/var/run/slurmd.pid
User=root
Group=root

[Install]
WantedBy=multi-user.target

###í™˜ê²½ë³€ìˆ˜ë³€ê²½

echo 'export PATH=/etc/slurm/bin:$PATH' | sudo tee -a /etc/profile
echo 'export LD_LIBRARY_PATH=/etc/slurm/lib:$LD_LIBRARY_PATH' | sudo tee -a /etc/profile
source /etc/profile

###ì„¤ì •íŒŒì¼ ì¹´í”¼

sudo mkdir -p /etc/slurm/etc
sudo cp /etc/slurm-llnl.bak/* /usr/local/slurm/etc/

sudo mkdir -p /var/spool/slurmctld
sudo mkdir -p /var/spool/slurmd
sudo mkdir -p /var/spool/slurm

/etc/slurm/cgroup.conf ****íŒŒì¼ ê¼­ ìƒì„± í•˜ê¸°

3.ì‹œê°„ë™ê¸°í™”

sudo apt-get install -y ntp
sudo vim /etc/ntp.conf
pool ëª¨ë‘ ì£¼ì„ì²˜ë¦¬
server 192.168.1.252 iburst  (ë‚´ë¶€ ntpì„œë²„ ipì£¼ì†Œ ì…ë ¥)
sudo systemctl enable ntp
sudo systemctl start ntp

***** scp ì•ˆë¨¹íë•Œ

sudo ssh-keygen -f "/home/user/.ssh/known_hosts" -R "node1"

***** slurm ì œê±°

cp /etc/slurm/*.* (ê²½ë¡œì§€ì •)    (ê¸°ì¡´ ì„¤ì •íŒŒì¼ ë°±ì—…)
sudo systemctl stop slurmctld slurmd
sudo apt-get remove --purge *slurm* -y

***slurm ë””ë²„ê¹…ëª¨ë“œ ì‹¤í–‰

sudo /etc/slurm/sbin/slurmd -D -v

***slurm cgroup í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜

sudo apt-get install libcgroup-dev cgroup-tools -y
mount | grep cgroup

***cgroup v1 í™œì„±í™”

/etc/default/grub íŒŒì¼ì—ì„œ GRUB_CMDLINE_LINUXì— systemd.unified_cgroup_hierarchy=0 ì¶”ê°€.
update-grub
ì¬ë¶€íŒ…

***slurm í´ë” ê¶Œí•œ ì„¤ì •

sudo chown -R slurm:slurm /var/spool/slurmctld
sudo chown -R slurm:slurm /var/spool/slurmd

*** íŒŒì¼ ê¶Œí•œ ì„¤ì •

sudo chmod 644 /var/run/slurmctld.pid
sudo chmod 644 /var/log/slurmctld.log ë“±ë“±

*** ë°©í™”ë²½ì œê±°

sudo ufw allow from 192.168.1.252/24  (í•´ë‹¹ ì•„ì´í”¼ ëª¨ë“  í¬íŠ¸ ê°œë°©)


*** ì‘ì—…ëª…ë ¹ ìƒ˜í”Œ

srun --ntasks=1 --cpus-per-task=1 --mem=1G --time=00:05:00 --partition=debug bash -c "echo 'Hello from Slurm\!'"

*** gpu burn ìŠ¤ëƒ… ì„¤ì¹˜

sudo snap install gpu-burn


*** ë…¸ë“œìƒíƒœí™•ì¸

scontrol show node
scontrol update nodename=node1 state=resume

*** í˜¸ìŠ¤íŠ¸ë„¤ì„ ë³€ê²½

sudo hostnamectl set-hostname newhostname

***ìŠ¬ëŸ¼ìœ ì € ì„¤ì • ë°©ë²•

sudo usermod -aG slurm user1

***ê³µìœ  ì‘ì—…í´ë” ìƒì„±

NFS ì„œë²„ ì„¤ì •(ë§ˆìŠ¤í„° ë…¸ë“œ):

sudo apt install nfs-kernel-server
sudo mkdir -p /shared/data
sudo chown -R nobody:nogroup /shared/data
sudo chmod 777 /shared/data
sudo echo "/shared/data *(rw,sync,no_subtree_check)" >> /etc/exports
sudo exportfs -a
sudo systemctl restart nfs-kernel-server

NFS í´ë¼ì´ì–¸íŠ¸ ì„¤ì •(ê³„ì‚° ë…¸ë“œ):

sudo apt install nfs-common
sudo mkdir -p /shared/data
sudo mount 192.168.1.229:/shared/data /shared/data

***ë‘ê°œì˜ ë…¸ë“œì—ì„œ nvidia-smi

srun -N 2 --ntasks=2 --gres=gpu:1 bash -c 'hostname && nvidia-smi'

***ë¡œê·¸íŒŒì¼ ì‹¤ì‹œê°„ í™•ì¸

tail -f output.log

****ìŠ¬ëŸ¼ Accounting(íšŒê³„) ê¸°ëŠ¥ ì‚¬ìš©ì„ ìœ„í•œ mariaDB ì„¸íŒ… (ì„ íƒ)

ë§ˆìŠ¤í„°ë…¸ë“œì— ì„¤ì¹˜

sudo apt install -y mariadb-server mariadb-client libmariadb-dev-compat
sudo mysql_secure_installation

ì²˜ìŒ ë£¨íŠ¸ íŒ¨ìŠ¤ì›Œë“œë¥¼ ì…ë ¥í•œë‹¤. ì²˜ìŒì´ë¯€ë¡œ ì—”í„°ë¥¼ ì…ë ¥ â€œEnter current password for root (enter for none): â€œ
Root passwordë¥¼ ë³€ê²½í•  ì˜ˆì •ì´ë¯€ë¡œ unix_socket authenicationì„ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤. â€œSwitch to unix_socket authentication [Y/n] nâ€
ìƒˆë¡œìš´ root passwordë¥¼ ì„¤ì •í•œë‹¤. â€œChange the root password? [Y/n] yâ€
ìµëª… ìœ ì € ë¡œê·¸ì¸ì„ ë§‰ì•˜ë‹¤. â€œRemove anonymous users? [Y/n] yâ€
ë³´ì•ˆì„ ìœ„í•´ root loginì„ remoteì—ì„œ í•˜ëŠ”ê±¸ ë§‰ëŠ”ë‹¤. â€œDisallow root login remotely? [Y/n] nâ€
test databaseë¥¼ ì œê±°í•œë‹¤. â€œRemove test database and access to it? [Y/n] yâ€
ì§€ê¸ˆê¹Œì§€ ì„¤ì •í•œê²ƒì„ ë°˜ì˜í•˜ê¸° ìœ„í•´ privilege tableë¥¼ reloadí•œë‹¤. â€œReload privilege tables now? [Y/n] yâ€

sudo mysql -u root -p
MariaDB [(none)]>
CREATE DATABASE slurm_acct_db;
CREATE USER 'slurm'@'localhost' IDENTIFIED BY '1q@';
GRANT ALL PRIVILEGES ON slurm_acct_db.* TO `slurm`@`localhost`;
FLUSH PRIVILEGES;
EXIT;

slurmbdb.conf ìƒì„±ë° ì…ë ¥

sudo chown slurm:slurm /etc/slurm/etc/slurmdbd.conf
sudo chmod 600 /etc/slurm/etc/slurmdbd.conf

ë§ˆìŠ¤í„°ë…¸ë“œ slurm.conf ì— ì…ë ¥

AccountingStorageType=accounting_storage/slurmdbd
AccountingStorageHost=localhost
AccountingStorageUser=slurm

echo 'export PATH=/etc/slurm/sbin:$PATH' | sudo tee -a /etc/profile
source ~/.bashrc

/etc/systemd/system/slurmdbd.service ë“±ë¡

[Unit]
Description=Slurm DBD Daemon
After=network.target mariadb.service
Requires=mariadb.service

[Service]
Type=simple
ExecStart=/etc/slurm/sbin/slurmdbd -D
User=slurm
Group=slurm
Restart=on-failure
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target



my.cnf íŒŒì¼ ìˆ˜ì •

[mysqld]
innodb_buffer_pool_size=4096M
innodb_log_file_size=64M
innodb_lock_wait_timeout=900
max_allowed_packet=16M

sacctmgr show cluster

ì‘ì—…ì™„ë£Œí›„ íšŒê³„ê¸°ëŠ¥ ì‚¬ìš©
sacct -u root --format=JobID,JobName,Partition,Account,AllocCPUs,State,ExitCode,MaxRSS,TotalCPU

*** ë¡œê·¸íŒŒì¼ ì‹¤ì‹œê°„ í™•ì¸

tail -f


*************** ìŠ¬ëŸ¼ê³¼ ê·¸ë¼íŒŒë‚˜ ì—°ë™ ì‘ì—… (ì„ íƒ)

sudo apt-get install prometheus prometheus-node-exporter -y
sudo systemctl start prometheus
sudo systemctl enable prometheus
systemctl status prometheus

git clone https://github.com/vpenso/prometheus-slurm-exporter.git
sudo apt install golang-go -y
make

cd ~/down/prometheus-slurm-exporter
nohup ./bin/prometheus-slurm-exporter &

prometheus.yml íŒŒì¼ ìˆ˜ì •

scrape_configs:
  - job_name: 'slurm'
    static_configs:
      - targets: ['192.168.1.229:8080']

íŒŒì¼ìˆ˜ì •í›„ ì„œë¹„ìŠ¤ ì¬ì‹œì‘
systemctl restart prometheus

http://192.168.1.229:9090/classic/targets ì ‘ì†í›„ slurm state up í™•ì¸

ê·¸ë¼íŒŒë‚˜ ì„¤ì¹˜

sudo mkdir -p /etc/apt/keyrings
curl -fsSL https://apt.grafana.com/gpg.key | sudo gpg --dearmor -o /etc/apt/keyrings/grafana.gpg
echo "deb [signed-by=/etc/apt/keyrings/grafana.gpg] https://apt.grafana.com stable main" | sudo tee /etc/apt/sources.list.d/grafana.list
sudo apt update
sudo apt install grafana -y
systemctl enable --now grafana-server

http://192.168.1.229:3000/login ì ‘ì† í™•ì¸
ì´ˆê¸°ì•”í˜¸ admin // admin

âœ… 1. Prometheusë¥¼ Grafana ë°ì´í„° ì†ŒìŠ¤ë¡œ ì¶”ê°€
Grafana ì›¹ UI ì ‘ì† â†’ http://ì„œë²„IP:3000

ì™¼ìª½ ì‚¬ì´ë“œë°” â†’ "ì»¤ë„¥ì…˜" â†’ "Data sources"

"Add data source" í´ë¦­

Prometheus ì„ íƒ

URL ì…ë ¥:

http
ë³µì‚¬
í¸ì§‘
http://localhost:9090
"Save & test" í´ë¦­ â†’ ì—°ê²° ì„±ê³µ ë©”ì‹œì§€ê°€ ë‚˜ì˜¤ë©´ ì™„ë£Œ

 2. Slurm ëŒ€ì‹œë³´ë“œ ê°€ì ¸ì˜¤ê¸°
Grafana ì»¤ë®¤ë‹ˆí‹°ì—ëŠ” Slurmì„ ìœ„í•œ ëŒ€ì‹œë³´ë“œê°€ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

ì™¼ìª½ ë©”ë‰´ â†’ ğŸ“Š "Dashboards" â†’ "Import"

ì•„ë˜ ì¤‘ í•˜ë‚˜ ì…ë ¥:

ì¶”ì²œ Slurm ëŒ€ì‹œë³´ë“œ ID:

ë³µì‚¬
í¸ì§‘
12239
ë˜ëŠ” ìµœì‹  ëŒ€ì‹œë³´ë“œ ê²€ìƒ‰ ì‹œ:

https://grafana.com/grafana/dashboards ì—ì„œ slurm ê²€ìƒ‰

Load í´ë¦­

Prometheus ë°ì´í„° ì†ŒìŠ¤ ì„ íƒ

Import í´ë¦­

 Grafanaì— Slurm ëŒ€ì‹œë³´ë“œ ì¶”ê°€ ë°©ë²•
Grafana ë¡œê·¸ì¸: ì›¹ ë¸Œë¼ìš°ì €ì—ì„œ Grafanaì— ë¡œê·¸ì¸í•©ë‹ˆë‹¤.

ëŒ€ì‹œë³´ë“œ ê°€ì ¸ì˜¤ê¸°:

ì™¼ìª½ ì‚¬ì´ë“œë°”ì—ì„œ "+" ì•„ì´ì½˜ì„ í´ë¦­í•œ í›„ "Import"ë¥¼ ì„ íƒí•©ë‹ˆë‹¤.

ì¶”ì²œí•œ ëŒ€ì‹œë³´ë“œì˜ IDë¥¼ "Grafana.com Dashboard" í•„ë“œì— ì…ë ¥í•˜ê³  "Load"ë¥¼ í´ë¦­í•©ë‹ˆë‹¤.

ë°ì´í„° ì†ŒìŠ¤ ì„¤ì •:

"Prometheus" ë°ì´í„° ì†ŒìŠ¤ë¥¼ ì„ íƒí•©ë‹ˆë‹¤.

ëŒ€ì‹œë³´ë“œ ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ:

"Import"ë¥¼ í´ë¦­í•˜ì—¬ ëŒ€ì‹œë³´ë“œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.

##### ê·¸ë¼íŒŒë‚˜ì— GPU ëŒ€ì‹œë³´ë“œ ì¶”ê°€

ê°ë…¸ë“œì— DCGM ì„¤ì¹˜

$ wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/cuda-keyring_1.0-1_all.deb
$ sudo dpkg -i cuda-keyring_1.0-1_all.deb
$ sudo add-apt-repository "deb https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/ /"

$ sudo apt-get update
  sudo apt-get install -y datacenter-gpu-manager
sudo systemctl --now enable nvidia-dcgm

DCGM Exporter ì„¤ì¹˜

apt install -y docker.io
sudo systemctl start docker
sudo systemctl enable docker
apt install -y nvidia-container-toolkit
sudo nvidia-ctk runtime configure --runtime=docker
sudo systemctl restart docker

docker run --gpus all -d --cap-add SYS_ADMIN -p 9400:9400 nvcr.io/nvidia/k8s/dcgm-exporter:4.1.1-4.0.4-ubuntu22.04 ë˜ëŠ”
docker run --gpus all -d --cap-add SYS_ADMIN --restart=always -p 9400:9400 \
  nvcr.io/nvidia/k8s/dcgm-exporter:4.1.1-4.0.4-ubuntu22.04 (ì¬ë¶€íŒ…ì‹œ ìë™ ì‹œì‘)


prometheus.yml íŒŒì¼ ìˆ˜ì •

scrape_configs:
  - job_name: 'dcgm-exporter'
    static_configs:
      - targets: ['192.168.1.228:9400', '192.168.1.229:9400']

systemctl restart prometheus

ê·¸ë¼íŒŒë‚˜ì—ì„œ DCGM ë©”íŠ¸ë¦­ìŠ¤ ì¤‘ gpu_utilizationì´ë‚˜ gpu_memory_usage ë“±ì„ ì‹œê°í™”
ê¸°ë³¸ NVIDIA DCGM ëŒ€ì‹œë³´ë“œ ê°€ì ¸ì˜¤ê¸°
https://grafana.com/grafana/dashboards/?search=nvidia
ì ‘ì†í•´ì„œ ë§˜ì— ë“œëŠ”ê²ƒ id í™•ì¸í›„ ì„í¬íŠ¸
ê¸°ë³¸ NVIDIA DCGM id 12239

**** ë‘ê°œì˜ ë…¸ë“œì— gpu-burn ì‹¤í–‰

ê°ë…¸ë“œì— snap install gpu-burn

srun --nodelist=node1,node2 --ntasks=2 --exclusive gpu-burn 60


**** ìŠ¬ëŸ¼ìœ ì € ë“±ë¡ ë°©ë²•

sudo adduser username
sudo usermod -aG slurm username
sudo passwd username

sudo sacctmgr add account devaccount Description="Development Group" Organization="devorg" Cluster=cluster
sudo sacctmgr add user username Account=devaccount DefaultAccount=devaccount Cluster=cluster

sacctmgr show user username format=User,Account,DefaultAccount,Cluster ë“±ë¡í™•ì¸




























